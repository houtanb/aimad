!
! Copyright (C) 2006-2014 Houtan Bastani and Luca Guerrieri
!
!
! This free software: you can redistribute it and/or modify
! it under the terms of the GNU General Public License as published by
! the Free Software Foundation, either version 3 of the License, or
! (at your option) any later version.
!
! It is distributed in the hope that it will be useful,
! but WITHOUT ANY WARRANTY; without even the implied warranty of
! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
! GNU General Public License for more details.
!
! You should have received a copy of the GNU General Public License
! along with Dynare.  If not, see <http://www.gnu.org/licenses/>.
!

!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade - Version 2.2 (r1239) - Wed 28 Jun 2006 04:59:55 PM CEST
!
!  Differentiation of outfile1 in forward (tangent) mode: (multi-directional mode)
!   variations  of output variables: h q
!   with respect to input variables: h q u
SUBROUTINE numeric_shift_in_loop_dv(h, hd, hprod, q, qd, neq, u, ud, qrows, qcols, iq&
&  , ns, lleft, rleft, selector, nbdirs)
  IMPLICIT NONE
  INTEGER, INTENT(IN) :: iq
  INTEGER, INTENT(IN) :: lleft
  INTEGER, INTENT(IN) :: nbdirs
  INTEGER, INTENT(IN) :: neq
  DOUBLE PRECISION, DIMENSION(neq, neq*3), INTENT(INOUT) :: h
  DOUBLE PRECISION :: hd(nbdirs, neq, neq*3)
  DOUBLE PRECISION, DIMENSION(neq, neq*3), INTENT(INOUT) :: hprod
  INTEGER, INTENT(IN) :: ns
  INTEGER, INTENT(IN) :: qcols
  INTEGER, INTENT(IN) :: qrows
  DOUBLE PRECISION, DIMENSION(qrows, qcols), INTENT(INOUT) :: q
  DOUBLE PRECISION :: qd(nbdirs, qrows, qcols)
  INTEGER, INTENT(IN) :: rleft
  INTEGER, DIMENSION(ns), INTENT(IN) :: selector
  DOUBLE PRECISION, DIMENSION(neq, neq), INTENT(INOUT) :: u
  DOUBLE PRECISION :: ud(nbdirs, neq, neq)
  INTEGER :: nd
  DOUBLE PRECISION, DIMENSION(:, :), ALLOCATABLE :: hpart2
  DOUBLE PRECISION, DIMENSION(:, :, :), ALLOCATABLE :: hpart2d, hprodd


  !
  ! DGEMM_DV
  !
  ALLOCATE( hprodd(nbdirs, neq, neq*3) )

  ! h = u'*h
  CALL DGEMM_DV('T', 'N', neq, 3*neq, neq, 1.d0, u, ud, neq, h, hd, neq, 0.d0, hprod, hprodd, neq, nbdirs)

  DO nd=1,nbdirs
    hd(nd, :, :) = hprodd(nd, :, :)
  END DO
  h = hprod

  DEALLOCATE( hprodd )




  IF (iq + ns .LE. qrows) THEN

    ALLOCATE( hpart2(ns, 3*neq), hpart2d(nbdirs, ns, 3*neq) )
    DO nd=1,nbdirs
      hpart2d(nd, :, :) = 0.D0
    END DO
    hpart2(:, :) = 0.0d0



    !
    ! SHIFTRIGHT_DV
    !
    CALL SHIFTRIGHT_DV( h(selector, :), hd(:, selector, :), ns, 3*neq, neq, hpart2, hpart2d, nbdirs )



    DO nd=1,nbdirs
      qd(nd, iq+1:iq+ns, :) = hd(nd, selector, lleft:rleft)
      hd(nd, selector, :) = hpart2d(nd, :, :)
    END DO

    q(iq+1:iq+ns, :) = h(selector, lleft:rleft)
    h(selector, :) = hpart2


    DEALLOCATE( hpart2, hpart2d )



  ELSE
    WRITE(*, *)
    WRITE(*, *) '*****  problem in numeric_shift *****'
    WRITE(*, *)
    RETURN
  END IF

END SUBROUTINE numeric_shift_in_loop_dv
